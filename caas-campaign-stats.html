<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`caas-campaign-stats`
Campaign Stats Data Element for Crowdfunding as a Service Solutions

@demo demo/index.html 
-->

<dom-module id="caas-campaign-stats">
  <template>

    <iron-ajax
      id="getCampaignStats"
      url="[[apiEndpoint]]/campaigns/[[campaignId]]/stats"
      handle-as="json"
      method="GET"
      last-response="{{_apiData}}"
      debounce-duration="3000"
    ></iron-ajax>

  </template>

  <script>
    Polymer({

      is: 'caas-campaign-stats',

      properties: {

        apiEndpoint: {
          type: String,
          value: null
        },

        campaignId: {
          type: String,
          value: null
        },

        loanCampaign: {
          type: Boolean,
          computed: '_computeLoanCampaign(_campaignTypeNames.*)',
          notify: true
        },

        sharesCampaign: {
          type: Boolean,
          computed: '_computeSharesCampaign(_campaignTypeNames.*)',
          notify: true
        },

        presaleCampaign: {
          type: Boolean,
          computed: '_computePresaleCampaign(_campaignTypeNames.*)',
          notify: true
        },

        status: {
          type: String,
          computed: '_getApiDataValue(_apiData.status)'
        },

        statusName: {
          type: String,
          computed: '_computeStatusName(status)',
          notify: true
        },

        startTime: {
          type: Number,
          computed: '_parseDateToTime(_apiData.startDateTime)',
          notify: true
        },

        endTime: {
          type: Number,
          computed: '_parseDateToTime(_apiData.endDateTime)',
          notify: true
        },

        daysLeft: {
          type: Number,
          computed: '_computeDaysLeft(endTime)',
          notify: true         
        },

        lastRepaymentTime: {
          type: Number,
          computed: '_parseUnixDateToTime(_apiData.finalPaymentDateTime)',
          notify: true
        },

        requiredFunding: {
          type: Number,
          computed: '_getApiDataValue(_apiData.requiredFunding)',
          notify: true
        },

        maximumFunding: {
          type: Number,
          computed: '_computeMaximumFunding(requiredFunding, _apiData.overtekenen)',
          notify: true
        },

        currentlyFunded: {
          type: Number,
          computed: '_getApiDataValue(_apiData.progressInEuros)',
          notify: true
        },

        numberOfFunders: {
          type: Number,
          computed: '_getApiDataValue(_apiData.numberOfInvestors)',
          notify: true
        },

        averageFunding: {
          type: Number,
          computed: '_getApiDataValue(_apiData.averageInvestment)',
          notify: true
        },

        nominalInterestRate: {
          type: Number,
          computed: '_getApiDataValue(_apiData.returnOnInvestmentPercentage)',
          notify: true
        },

        nominalInterestRatePerYear: {
          type: Number,
          computed: '_computeNominalInterestRatePerYear(nominalInterestRate, interestRateRefundTerms)',
          notify: true
        },

        effectiveInterestRatePerYear: {
          type: Number,
          computed: '_getApiDataValue(_apiData.effectiveInterestRate)',
          notify: true
        },

        interestRateRefundTerms: {
          type: Number,
          computed: '_getApiDataValue(_apiData.paymentDuration)',
          notify: true
        },

        closed: {
          type: Boolean,
          computed: '_getApiDataValue(_apiData.campaignBlocked)',
          notify: true
        },

        _campaignTypeNames: {
          type: Array,
          computed: '_computeCampaignTypeNames(_apiData.contractTypes.*)',
          notify: true
        },

        _apiData: {
          type: Object,
          value: {}
        }

      },

      observers: [
        '_getApiData(apiEndpoint, campaignId)'
      ],

      _getApiData: function(apiEndpoint, campaignId) {
        if(!apiEndpoint && campaignId) return;
        this.$.getCampaignStats.generateRequest();
      },

      _computeStatusName: function(status) {
        switch(status) {
          case 0:
            return 'draft';
            break;
          case 1:
            return 'in-progress';
            break;
          case 2:
          case 3:
          case 4:
            return 'success';
            break;
          default:
            return 'closed';
            break;
        }
      },

      _computeDaysLeft: function(endDate) {
        var oneDay = 24*60*60*1000;
        var now = new Date().getTime();
        var daysLeft = Math.round(Math.abs(now - endDate)/(oneDay));
        return daysLeft;
      },

      _computeNominalInterestRatePerYear: function(nominalInterestRate, interestRateRefundTerms) {
        var years = interestRateRefundTerms / 12;
        return (nominalInterestRate / years);
      },

      _computeMaximumFunding: function(requiredFunding, overtekenen) {
        return (requiredFunding + overtekenen);
      },

      _computeLoanCampaign(campaignTypeName) {
        var campaignTypeNames = campaignTypeName.base;
        if(!campaignTypeNames) return false;
        return campaignTypeNames.indexOf('lening') !== -1;
      },

      _computeSharesCampaign: function(campaignTypeName) {
        var campaignTypeNames = campaignTypeName.base;
        if(!campaignTypeNames) return false;
        return campaignTypeNames.indexOf('aandelen') !== -1;        
      },

      _computePresaleCampaign: function(campaignTypeName) {
        var campaignTypeNames = campaignTypeName.base;
        if(!campaignTypeNames) return false;
        return campaignTypeNames.indexOf('voorverkoop') !== -1;        
      },

      _computeCampaignTypeNames: function(campaignType) {
        var campaignTypes = campaignType.base;
        if(!campaignTypes) return [];
        var campaignTypeNames = campaignTypes.map(function(campaignType) {
          return campaignType.name.toLowerCase();
        })
        return campaignTypeNames;
      },

      _getApiDataValue: function(apiDataValue) {
        return apiDataValue;
      },

      _parseUnixDateToTime: function(unixDate) {
        var timeValue = parseInt(unixDate + '000');
        return new Date(timeValue).getTime();
      },

      _parseDateToTime: function(dateValue) {
        return new Date(dateValue).getTime();
      }

    });
  </script>
</dom-module>
